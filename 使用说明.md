# FunctionPlotter 使用说明

## 📋 目录

1. [简介](#简介)
2. [快速开始](#快速开始)
3. [安装指南](#安装指南)
4. [功能详解](#功能详解)
5. [操作指南](#操作指南)
6. [常见问题](#常见问题)
7. [技术支持](#技术支持)

---

## 1. 简介

FunctionPlotter 是一个基于 PyQt6 的专业工具，集成以下功能：

- ✅ **数学函数曲线绘制**：支持复杂数学表达式可视化
- ✅ **Modbus设备监控**：支持TCP/RTU协议实时数据采集
- ✅ **历史数据分析**：完整的数据查询、可视化、导出功能
- ✅ **多通道支持**：最多10个通道同时采集
- ✅ **自定义函数库**：快速保存和使用常用表达式
- ✅ **数据持久化**：SQLite数据库存储，支持CSV导出

**适用场景**：
- 工业自动化设备监控
- 实验室数据采集与分析
- 数学函数教学演示
- 历史数据趋势分析

---

## 2. 快速开始

### 2.1 运行程序

```bash
# 安装依赖（首次运行）
pip install -r requirements.txt

# 运行程序
python function_plotter.py
```

### 2.2 界面导航

程序采用标签页设计：
- 📊 **函数曲线**：数学函数绘制
- 🔌 **实时监控**：Modbus数据采集
- 📈 **历史数据**：历史查询分析
- ⚙️ **实时曲线样式**：图表外观设置

---

## 3. 安装指南

### 3.1 系统要求

| 项目 | 要求 |
|------|------|
| 操作系统 | Windows 10/11 (64位) |
| Python版本 | 3.8 或更高 |
| 运行库 | Visual C++ Redistributable |
| 内存 | 4GB+ (建议8GB) |
| 硬盘空间 | 100MB+ |

### 3.2 安装步骤

**步骤1：安装Python**
- 从[python.org](https://www.python.org/downloads/)下载Python 3.8+
- 安装时勾选"Add Python to PATH"

**步骤2：安装依赖**
```bash
cd function-plotter
pip install -r requirements.txt
```

**步骤3：验证安装**
```bash
python function_plotter.py
```

### 3.3 依赖说明

```
PyQt6==6.7.0          # GUI框架
numpy==1.26.4         # 数值计算
matplotlib==3.8.4     # 图表绘制
pymodbus==3.7.4       # Modbus协议
pyserial==3.5         # 串口通信
pyinstaller>=6.0.0    # 打包工具（可选）
```

---

## 4. 功能详解

### 4.1 函数曲线绘制

#### 4.1.1 基本操作

**绘制函数曲线：**

1. 切换到"函数曲线"标签页
2. 在"函数 f(x)"输入框中输入表达式
3. 设置X轴范围（最小值/最大值）
4. （可选）设置采样点数（默认1000）
5. 点击"绘制曲线"按钮

**示例表达式：**
```python
sin(x)              # 正弦波
x**2 + 2*x + 1     # 二次函数
exp(-x**2)          # 高斯分布
log(x) + sqrt(x)     # 复合函数
sin(x) * cos(2*x)    # 调幅波
```

#### 4.1.2 快速函数按钮

点击按钮快速添加函数：
- **sin** - 正弦函数
- **cos** - 余弦函数
- **tan** - 正切函数
- **exp** - 指数函数
- **log** - 自然对数
- **sqrt** - 平方根

#### 4.1.3 自定义函数库

**添加函数：**
1. 点击"添加函数"按钮
2. 填写：
   - 函数名称（如"my_func"）
   - 函数表达式（如"sin(x)+cos(x)"）
   - 描述（可选）
3. 点击"确定"

**使用函数：**
1. 在"自定义函数库"列表中选择函数
2. 点击"使用选中"
3. 表达式自动加载到输入框

**删除函数：**
1. 选择函数
2. 点击"删除函数"
3. 确认删除

#### 4.1.4 样式设置

**线条样式：**
- 颜色：蓝色、红色、绿色、橙色、紫色等
- 宽度：1-5像素
- 样式：实线、虚线、点线、点划线

**图表选项：**
- 显示/隐藏网格
- 显示/隐藏图例
- 显示/隐藏数据标记
- 标记样式：圆形、方形、三角形等

### 4.2 Modbus实时监控

#### 4.2.1 模式选择

**单通道模式**：
- 使用传统设备参数配置
- 适合简单场景
- 适合单点数据采集

**多通道模式**（推荐）：
- 支持最多10个通道同时采集
- 每个通道独立配置参数
- 不同通道用不同颜色显示
- 适合复杂监控场景

#### 4.2.2 多通道配置

**添加通道：**

1. 在"通道管理"区域点击"添加通道"
2. 填写通道信息：

| 参数 | 说明 | 示例 |
|------|------|------|
| 通道名称 | 通道标识 | "温度传感器" |
| 从站ID | Modbus从站地址 | 1 |
| 起始地址 | 寄存器地址 | 0 |
| 寄存器数量 | 读取数量 | 1 |
| 功能码 | 寄存器类型 | 03 |
| 单位 | 物理单位 | "℃" |
| 缩放比例 | 数值转换 | 0.1 |
| 偏移量 | 数值转换 | 0.0 |
| 曲线颜色 | 显示颜色 | "红色" |

3. 点击"确定"添加

**功能码说明：**
- **03**: 读取保持寄存器（最常用）
- **04**: 读取输入寄存器
- **01**: 读取线圈状态
- **02**: 读取离散输入状态

**缩放和偏移：**
- 公式：`实际值 = 原始值 × 缩放 + 偏移`
- 示例：原始值224，缩放0.1 → 显示22.4

#### 4.2.3 连接设备

**TCP模式：**

1. 选择"TCP"连接方式
2. 设置参数：
   - 主机地址：设备IP（如"192.168.1.100"）
   - 端口：默认502
3. 点击"连接设备"

**RTU模式：**

1. 选择"RTU"连接方式
2. 点击"搜索"按钮查找串口
3. 从列表选择串口（如"COM3"）
4. 设置串口参数：
   - 波特率：9600（常用）
   - 数据位：8
   - 停止位：1
   - 校验位：无/奇校验/偶校验
5. 点击"连接设备"

**常见问题：**
- 搜索不到串口 → 检查驱动、设备管理器
- 连接失败 → 检查参数、线缆、设备状态
- 权限不足 → 以管理员身份运行程序

#### 4.2.4 数据采集

**参数设置：**

- **采集间隔**：数据读取频率（建议≥100ms）
- **存储间隔**：数据库保存间隔（建议≥5秒）
- **保存到数据库**：勾选启用存储

**开始采集：**

1. 确认通道已配置
2. 设备已连接
3. 设置采集参数
4. 点击"开始采集"

**实时显示：**

- 曲线区域显示实时数据
- 左上角显示各通道最新值
- 格式：`通道名: 数值 (时间)`
- 鼠标悬停显示详细数据

**停止采集：**

- 点击"停止采集"暂停
- 点击"清除数据"清空缓冲区

#### 4.2.5 寄存器配置

**用途**：快速加载常用配置

**添加配置：**
1. 点击"添加配置"
2. 填写参数（同添加通道）
3. 点击"确定"保存

**使用配置：**
1. 在列表中选择配置
2. 点击"使用配置"
3. 参数自动加载

**删除配置：**
1. 选择配置
2. 点击"删除配置"

### 4.3 历史数据分析

#### 4.3.1 查询数据

1. 切换到"历史数据"标签页
2. 设置查询条件：
   - 开始时间（日期+时间）
   - 结束时间（日期+时间）
   - 从站ID（可选，筛选特定设备）
3. 点击"查询"

#### 4.3.2 查看曲线

1. 查询到数据后
2. 点击"显示曲线"
3. 系统自动按地址分组绘制
4. 不同地址使用不同颜色

#### 4.3.3 导出数据

1. 查询到数据后
2. 点击"导出CSV"
3. 选择保存位置
4. 文件包含所有查询结果

**CSV格式：**
```csv
ID,时间戳,从站ID,地址,功能码,数值,单位
1,2024-01-01 12:00:00.123456,1,0,3,22.4,℃
2,2024-01-01 12:00:01.123456,1,1,3,38.5,%
```

#### 4.3.4 删除数据

⚠️ **警告：操作不可撤销**

**删除选中：**
1. 在表格中选择行（可多选）
2. 点击"删除选中数据"
3. 确认删除

**删除查询结果：**
1. 设置查询条件
2. 点击"删除查询结果"（红色按钮）
3. 确认删除

### 4.4 样式设置

#### 4.4.1 实时曲线样式

**设置方法：**
1. 在图表区域右键点击
2. 弹出样式设置对话框
3. 调整参数：
   - 线条颜色
   - 线条宽度（1-5）
   - 线条样式（实线、虚线、点线）
   - 透明度（0-100%）
   - 显示/隐藏网格
   - 显示/隐藏图例
   - 显示/隐藏标记
   - 标记样式（圆形、方形、三角形等）
4. 点击"确定"应用

#### 4.4.2 多通道颜色

在多通道模式下：
- 每个通道使用独立颜色
- 在"修改配置"中设置
- 右键菜单的颜色设置被禁用

---

## 5. 操作指南

### 5.1 快速操作清单

**绘制函数曲线：**
- [ ] 输入函数表达式
- [ ] 设置x轴范围
- [ ] 点击"绘制曲线"

**Modbus监控：**
- [ ] 配置通道参数
- [ ] 连接设备
- [ ] 设置采集间隔
- [ ] 点击"开始采集"

**历史查询：**
- [ ] 设置时间范围
- [ ] 点击"查询"
- [ ] （可选）点击"显示曲线"
- [ ] （可选）点击"导出CSV"

### 5.2 鼠标操作

**图表区域：**
- 左键拖动：平移图表
- 滚轮：缩放图表
- 右键：打开样式设置菜单
- 悬停：显示数据提示

**表格区域：**
- 左键：选择单行
- Ctrl+左键：多选
- Shift+左键：连续选择

### 5.3 快捷键

| 快捷键 | 功能 | 适用场景 |
|--------|------|----------|
| Ctrl+Enter | 绘制曲线 | 函数曲线标签页 |
| F5 | 刷新查询 | 历史数据标签页 |
| Delete | 删除选中 | 列表/表格 |

---

## 6. 常见问题

### Q1: 程序无法启动

**原因分析：**
1. Python版本过低
2. 依赖包未安装
3. 缺少运行库

**解决方案：**
```bash
# 检查Python版本
python --version  # 需要3.8+

# 安装依赖
pip install -r requirements.txt

# 安装运行库
# 下载并安装 Visual C++ Redistributable
```

### Q2: 中文显示乱码

**解决方案：**
程序已内置中文字体支持，通常无需额外配置。

如仍有问题：
1. 确认系统已安装中文字体（SimHei、微软雅黑）
2. 重启程序
3. 检查系统区域设置

### Q3: Modbus连接失败

**检查清单：**
- [ ] 设备已上电并正常连接
- [ ] IP地址/端口配置正确
- [ ] 串口参数正确（RTU模式）
- [ ] 从站ID正确
- [ ] 线缆连接正常
- [ ] 无防火墙阻止

**排查步骤：**
1. 使用Modbus Poll等工具测试设备
2. 检查网络连通性（TCP模式）
3. 检查串口驱动（RTU模式）
4. 确认设备支持的功能码

### Q4: RTU模式找不到串口

**解决方案：**
1. 点击"搜索"按钮自动查找
2. 检查设备管理器中的COM端口
3. 确认USB转串口驱动已安装
4. 尝试手动输入COM端口名称
5. 更换USB端口重试

### Q5: 曲线不显示或显示异常

**可能原因：**
1. 数据范围设置不当
2. 采集间隔太短
3. 数值超出图表范围
4. 无数据或数据异常

**解决方法：**
1. 检查Y轴范围
2. 增大采集间隔
3. 点击工具栏"自动缩放"
4. 检查Modbus连接
5. 查看调试输出

### Q6: 数据采集过程中程序卡死

**原因分析：**
1. 采集间隔设置过短
2. 通道数量过多
3. 系统资源不足
4. 数据库操作阻塞

**解决方法：**
1. 增大采集间隔（建议≥100ms）
2. 减少通道数量（建议≤10）
3. 关闭不必要的后台程序
4. 重启程序
5. 定期清理历史数据

### Q7: 如何备份数据

**备份方法：**
```bash
# 1. 关闭程序
# 2. 复制数据库文件
cp modbus_data.db modbus_data_backup_2024.db

# 3. 妥善保存
# 备份文件可以随时恢复
```

**恢复方法：**
1. 关闭程序
2. 将备份文件重命名为 `modbus_data.db`
3. 覆盖原文件
4. 启动程序

### Q8: 多通道颜色设置

**设置方法：**
1. 在通道列表中选择通道
2. 点击"修改配置"
3. 选择"曲线颜色"
4. 点击"确定"保存
5. 采集时自动应用

**注意**：多通道模式下，右键菜单的颜色设置被禁用。

### Q9: 历史查询速度慢

**优化方法：**
1. 缩短查询时间范围
2. 添加从站ID筛选
3. 定期清理旧数据
4. 对数据库进行优化
5. 考虑使用索引

### Q10: 右键菜单颜色设置不可用

**原因：**
在多通道模式下，每个通道使用独立颜色，全局颜色设置被禁用。

**解决方法：**
通过"修改配置"对话框设置单个通道的颜色。

---

## 7. 技术支持

### 7.1 获取帮助

**查看日志：**
程序运行时会在控制台输出调试信息，记录错误以便排查。

**检查文档：**
- 本文档涵盖大部分使用场景
- 程序界面有操作提示

**数据库检查：**
```bash
# 查看数据库文件
ls -lh modbus_data.db

# 使用SQLite工具查看数据
sqlite3 modbus_data.db "SELECT * FROM modbus_data LIMIT 10;"
```

### 7.2 性能优化

**采集参数优化：**
- 采集间隔 ≥ 100ms
- 存储间隔 ≥ 5秒
- 存储间隔 ≥ 采集间隔

**数据库优化：**
- 定期清理旧数据
- 控制数据库文件大小（建议<1GB）
- 定期备份和压缩

**系统优化：**
- 关闭不必要的后台程序
- 确保足够的内存（建议8GB+）
- 使用SSD提高性能

### 7.3 最佳实践

**日常使用：**
1. 启动程序后先检查连接
2. 配置好通道再开始采集
3. 定期查看数据库大小
4. 及时备份重要数据

**数据管理：**
1. 为通道设置有意义的名称
2. 使用单位标识数据类型
3. 合理设置缩放和偏移
4. 定期导出数据备份

**故障排查：**
1. 记录错误信息
2. 查看控制台输出
3. 检查数据库完整性
4. 尝试重启程序

---

## 📚 附录

### 附录A: 支持的数学函数

**三角函数：**
```python
sin(x), cos(x), tan(x)
asin(x), acos(x), atan(x)
```

**双曲函数：**
```python
sinh(x), cosh(x), tanh(x)
```

**指数对数：**
```python
exp(x)      # 自然指数
log(x)      # 自然对数
log10(x)    # 以10为底对数
log2(x)     # 以2为底对数
```

**其他函数：**
```python
sqrt(x)     # 平方根
abs(x)      # 绝对值
pow(x, y)   # 幂运算
round(x)    # 四舍五入
```

**常数：**
```python
pi          # 圆周率 π
e           # 自然常数 e
```

### 附录B: 数据库结构

**modbus_data表：**
```sql
CREATE TABLE modbus_data (
    id INTEGER PRIMARY KEY,
    timestamp TEXT,          -- 时间戳
    slave_id INTEGER,        -- 从站ID
    address INTEGER,         -- 寄存器地址
    function_code INTEGER,   -- 功能码
    value REAL,              -- 数值
    unit TEXT                -- 单位
);
```

**custom_functions表：**
```sql
CREATE TABLE custom_functions (
    id INTEGER PRIMARY KEY,
    name TEXT,               -- 函数名称
    expression TEXT,         -- 函数表达式
    description TEXT         -- 描述
);
```

**register_configs表：**
```sql
CREATE TABLE register_configs (
    id INTEGER PRIMARY KEY,
    name TEXT,               -- 配置名称
    slave_id INTEGER,        -- 从站ID
    address INTEGER,         -- 地址
    count INTEGER,           -- 数量
    function_code INTEGER,   -- 功能码
    unit TEXT,               -- 单位
    scale REAL,              -- 比例
    offset REAL,             -- 偏移量
    color TEXT               -- 曲线颜色
);
```

### 附录C: 快捷键列表

| 快捷键 | 功能 | 适用范围 |
|--------|------|----------|
| `Ctrl+Enter` | 绘制曲线 | 函数曲线 |
| `F5` | 刷新查询 | 历史数据 |
| `Delete` | 删除选中项 | 所有列表 |
| `Ctrl+S` | 保存图表 | 图表区域 |
| `Ctrl+C` | 复制数据 | 表格区域 |

### 附录D: 文件格式说明

**CSV导出格式：**
```csv
ID,时间戳,从站ID,地址,功能码,数值,单位
1,2024-01-01 12:00:00.123456,1,0,3,22.4,℃
2,2024-01-01 12:00:01.123456,1,1,3,38.5,%
```

**数据库文件：**
- 文件名：`modbus_data.db`
- 格式：SQLite 3
- 位置：程序运行目录

---

## 📝 更新日志

### v1.0.0 (2024-01-XX)
- ✨ 初始版本发布
- ✨ 支持函数曲线绘制
- ✨ 支持Modbus TCP/RTU连接
- ✨ 支持多通道数据采集
- ✨ 支持历史数据查询
- ✨ 支持数据导出功能
- ✨ 支持自定义函数库
- ✨ 支持图表样式自定义

---

<div align="center">

**⭐ 感谢您使用 FunctionPlotter！**

如有问题或建议，欢迎反馈。

**祝您使用愉快！**

</div>
