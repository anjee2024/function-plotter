# FunctionPlotter 使用说明

## 目录
1. [简介](#简介)
2. [快速开始](#快速开始)
3. [安装](#安装)
4. [功能模块](#功能模块)
5. [详细使用指南](#详细使用指南)
6. [常见问题](#常见问题)
7. [技术支持](#技术支持)

## 简介

FunctionPlotter 是一个基于 PyQt6 的多功能应用程序，主要功能包括：

- ✅ 数学函数曲线绘制
- ✅ Modbus TCP/RTU 设备实时数据监控
- ✅ 历史数据查询和可视化
- ✅ 多通道数据采集
- ✅ 自定义函数库管理

## 快速开始

### 运行程序

```bash
# 安装依赖
pip install -r requirements.txt

# 运行主程序
python function_plotter.py
```

### 选择不同版本

- **function_plotter.py** - 完整版（所有功能）
- **data_collector.py** - 数据采集器（专注Modbus采集）
- **history_viewer.py** - 历史数据查看器（专注历史查询）
- **function_plotter_simple.py** - 基础函数绘制器（专注函数绘图）

## 安装

### 系统要求

- **操作系统**: Windows 10/11 64位
- **Python**: 3.8 或更高版本
- **运行库**: Visual C++ Redistributable（通常系统已包含）

### 安装步骤

1. 下载程序文件
2. 安装 Python 依赖：
   ```bash
   pip install -r requirements.txt
   ```
3. 运行程序：
   ```bash
   python function_plotter.py
   ```

### 依赖包说明

```
PyQt6==6.7.0          # GUI框架
numpy==1.26.4          # 数值计算
matplotlib==3.8.4       # 图表绘制
pymodbus==3.7.4        # Modbus协议
pyserial==3.5           # 串口通信
```

## 功能模块

### 1. 函数曲线绘制

**功能特点：**
- 支持常见数学函数表达式
- 自定义函数库管理
- 参数配置（x轴范围、采样点数）
- 样式设置（线条颜色、宽度）
- 快速函数按钮
- 网格显示/隐藏
- 中文字符支持

### 2. Modbus 实时数据监控

**功能特点：**
- 支持 Modbus TCP 和 RTU 连接
- 多通道数据采集（最多10个通道）
- 寄存器配置管理
- 实时曲线显示
- 数据存储到SQLite数据库
- 采集间隔可调
- 数据导出功能

**支持的功能码：**
- 0x01 - 读取线圈
- 0x02 - 读取离散输入
- 0x03 - 读取保持寄存器
- 0x04 - 读取输入寄存器

### 3. 历史数据查询

**功能特点：**
- 时间范围查询
- 从站ID筛选
- 数据表格展示
- 曲线可视化
- 数据导出为CSV
- 数据删除功能

## 详细使用指南

### 函数曲线绘制

#### 基本使用

1. **切换到函数绘制标签页**
   - 点击顶部标签栏的"函数曲线"标签

2. **输入函数表达式**
   - 在"函数 f(x)"输入框中输入数学表达式
   - 示例：
     ```
     sin(x)              # 正弦函数
     x**2 + 2*x + 1     # 二次函数
     exp(-x**2)          # 高斯函数
     log(x) + sqrt(x)     # 对数+平方根
     ```

3. **设置参数**
   - **X轴范围**: 设置x的最小值和最大值
   - **采样点数**: 设置曲线的精度（点数越多越平滑）

4. **调整样式**
   - **线条颜色**: 选择曲线颜色
   - **线条宽度**: 设置线条粗细

5. **绘制曲线**
   - 点击"绘制曲线"按钮
   - 曲线将显示在右侧图表区域

#### 使用快速函数

程序内置了常用数学函数按钮：
- **sin** - 正弦函数
- **cos** - 余弦函数
- **tan** - 正切函数
- **exp** - 指数函数
- **log** - 对数函数
- **sqrt** - 平方根函数
- **abs** - 绝对值函数

点击按钮即可快速添加函数到输入框。

#### 管理自定义函数

**添加自定义函数：**

1. 点击"添加函数"按钮
2. 在弹出的对话框中输入：
   - **函数名称**: 例如 "my_function"
   - **函数表达式**: 例如 "sin(x) + cos(x)"
   - **描述**: 可选，例如 "正弦余弦组合"

3. 点击"确定"保存函数

**使用自定义函数：**

1. 在"自定义函数库"列表中选择函数
2. 点击"使用选中"按钮
3. 函数表达式将自动加载到输入框

**删除自定义函数：**

1. 在"自定义函数库"列表中选择函数
2. 点击"删除函数"按钮
3. 确认删除

### Modbus 实时数据监控

#### 模式选择：单通道 vs 多通道

**单通道模式：**
- 使用传统的设备参数配置
- 适合简单的单点采集场景

**多通道模式：**
- 支持同时采集多个通道数据
- 每个通道独立配置从站ID、地址、功能码
- 不同通道使用不同颜色曲线显示
- 适合复杂的监控场景

#### 多通道配置

**添加通道：**

1. 在"通道管理"区域，点击"添加通道"按钮
2. 填写通道信息：
   - **通道名称**: 例如 "温度传感器"
   - **从站ID**: Modbus从站地址（1-247）
   - **起始地址**: 寄存器地址
   - **寄存器数量**: 要读取的寄存器个数
   - **功能码**:
     - 3: 读取保持寄存器
     - 4: 读取输入寄存器
     - 1: 读取线圈
     - 2: 读取离散输入
   - **单位**: 可选，例如 "℃"、"V"
   - **比例**: 数值转换比例（默认1.0）
   - **偏移量**: 数值转换偏移（默认0.0）
   - **曲线颜色**: 选择曲线显示颜色

3. 点击"确定"添加通道

**删除通道：**

1. 在通道列表中选择要删除的通道
2. 点击"删除通道"按钮
3. 确认删除

**修改通道配置：**

1. 在通道列表中选择要修改的通道
2. 点击"修改配置"按钮
3. 修改配置信息
4. 点击"确定"保存修改

#### 连接设备

**TCP 模式：**

1. 选择连接方式为"TCP"
2. 设置参数：
   - **主机地址**: 例如 "192.168.1.100"
   - **端口**: 例如 502（默认）

**RTU 模式：**

1. 选择连接方式为"RTU"
2. 点击"搜索"按钮查找可用串口
3. 从下拉列表中选择串口（例如 COM3）
4. 设置串口参数：
   - **波特率**: 9600（常用值）
   - **数据位**: 8
   - **停止位**: 1
   - **校验位**: 无/奇校验/偶校验

3. 点击"连接设备"按钮

#### 开始数据采集

1. 设置采集参数：
   - **采集间隔**: 设置数据采集频率（毫秒）
   - **存储间隔**: 设置数据保存到数据库的间隔（秒）
   - **保存到数据库**: 勾选启用数据库存储

2. 点击"开始采集"按钮

3. 实时曲线将开始更新显示：
   - 单通道模式：显示一条曲线
   - 多通道模式：显示多条曲线，每条曲线对应一个通道

4. 实时数据显示：
   - 曲线上方显示各通道的最新值
   - 包括数值和采集时间

#### 停止和清除数据

- **停止采集**: 点击"停止采集"按钮暂停数据采集
- **清除数据**: 点击"清除数据"按钮清空所有采集的数据

#### 使用寄存器配置

**添加配置：**

1. 在"寄存器配置"区域，点击"添加配置"按钮
2. 填写配置信息（与添加通道类似）
3. 点击"确定"保存配置

**使用配置：**

1. 在寄存器配置列表中选择配置
2. 点击"使用配置"按钮
3. 配置信息将自动加载到设备参数区域

**删除配置：**

1. 在寄存器配置列表中选择配置
2. 点击"删除配置"按钮

### 历史数据查询

#### 查询历史数据

1. **切换到历史数据标签页**
   - 点击顶部标签栏的"历史数据"标签

2. **设置查询条件：**
   - **开始时间**: 设置查询的开始日期和时间
   - **结束时间**: 设置查询的结束日期和时间
   - **从站ID**（可选）: 筛选特定从站的数据

3. **点击"查询"按钮**
   - 数据将以表格形式显示在左侧

#### 查看历史曲线

1. 查询到数据后
2. 点击"显示曲线"按钮
3. 系统将按寄存器地址分组绘制曲线
   - 每个不同的地址使用不同颜色
   - 曲线显示在右侧图表区域

#### 导出数据

1. 查询到数据后
2. 点击"导出CSV"按钮
3. 选择保存位置
4. 文件将以CSV格式保存，包含所有查询结果

#### 删除历史数据

⚠️ **警告：删除操作不可撤销，请谨慎操作！**

**删除选中数据：**

1. 在数据表格中选择要删除的行（支持多选）
2. 点击"删除选中数据"按钮
3. 在确认对话框中查看详细信息
4. 点击"是"确认删除

**删除查询结果：**

1. 设置好查询条件
2. 点击"删除查询结果"按钮（红色按钮）
3. 在确认对话框中查看要删除的数据条件
4. 点击"是"确认删除

### 曲线样式设置

#### 实时曲线样式

1. 在实时曲线图表区域**右键点击**
2. 弹出样式设置对话框
3. 可设置：
   - **线条颜色**: 曲线颜色
   - **线条宽度**: 曲线粗细
   - **线条样式**: 实线、虚线、点线等
   - **透明度**: 曲线透明度
   - **显示网格**: 显示/隐藏坐标网格
   - **显示图例**: 显示/隐藏曲线图例
   - **显示标记**: 显示/隐藏数据点标记
   - **标记样式**: 标记的形状

4. 点击"确定"应用样式

#### 历史曲线样式

1. 在历史曲线图表区域**右键点击**
2. 弹出样式设置对话框
3. 设置方法与实时曲线相同

#### 多通道颜色设置

在多通道模式下，每个通道的颜色在通道配置中设置：
1. 在通道列表中点击"修改配置"
2. 在"曲线颜色"下拉框中选择颜色
3. 点击"确定"保存
4. 如果正在采集，曲线颜色会立即更新

### 数据库说明

程序使用 SQLite 数据库存储数据：

**数据库文件位置：**
- 程序运行时自动创建在程序目录下
- 文件名：`modbus_data.db`

**数据库表结构：**

**modbus_data 表**（历史数据）：
- id: 主键
- timestamp: 时间戳
- slave_id: 从站ID
- address: 寄存器地址
- function_code: 功能码
- value: 数值
- unit: 单位

**custom_functions 表**（自定义函数）：
- id: 主键
- name: 函数名称
- expression: 函数表达式
- description: 描述

**register_configs 表**（寄存器配置）：
- id: 主键
- name: 配置名称
- slave_id: 从站ID
- address: 地址
- count: 数量
- function_code: 功能码
- unit: 单位
- scale: 比例
- offset: 偏移量
- color: 曲线颜色

## 常见问题

### Q1: 程序无法启动

**可能原因：**
1. Python版本过低（需要3.8+）
2. 依赖包未安装
3. 缺少运行库

**解决方法：**
1. 检查Python版本：`python --version`
2. 安装依赖：`pip install -r requirements.txt`
3. 安装Visual C++ Redistributable

### Q2: 中文显示为乱码

**解决方法：**
程序已内置中文字体支持，如仍有问题：
1. 确保系统已安装中文字体（SimHei、微软雅黑等）
2. 重启程序

### Q3: Modbus连接失败

**检查清单：**
1. 设备是否正常连接
2. IP地址/端口配置是否正确
3. 串口参数是否正确
4. 从站ID是否正确
5. 是否有防火墙阻止

**解决方法：**
1. 尝试使用Modbus调试工具测试连接
2. 检查网络/串口连接
3. 确认设备参数配置

### Q4: RTU模式下找不到串口

**解决方法：**
1. 点击"搜索"按钮自动搜索
2. 检查串口驱动是否已安装
3. 在设备管理器中确认COM端口名称
4. 手动输入COM端口名称（例如：COM3）

### Q5: 曲线不显示或显示异常

**可能原因：**
1. 数据范围设置不当
2. 采集间隔太短
3. 数值超出图表范围

**解决方法：**
1. 检查Y轴范围设置
2. 增大采集间隔
3. 点击图表工具栏的"自动缩放"按钮

### Q6: 数据采集过程中程序卡死

**解决方法：**
1. 增大采集间隔（建议≥100ms）
2. 减少通道数量
3. 关闭不必要的后台程序
4. 重启程序

### Q7: 如何备份数据

**备份数据库：**
1. 关闭程序
2. 复制 `modbus_data.db` 文件到备份位置
3. 备份文件可以随时恢复

### Q8: 多通道模式下颜色如何设置？

**设置方法：**
1. 点击"修改配置"按钮
2. 在"曲线颜色"下拉框中选择颜色
3. 保存配置
4. 颜色会立即应用到对应的通道

### Q9: 如何修改数据存储位置？

**解决方法：**
当前版本数据库默认保存在程序目录，可以通过以下方式修改：
1. 移动 `modbus_data.db` 到新位置
2. 程序会自动在新位置创建数据库

### Q10: 支持哪些数学函数？

**支持的函数：**
- **三角函数**: sin, cos, tan, asin, acos, atan
- **双曲函数**: sinh, cosh, tanh
- **指数对数**: exp, log, log10, log2
- **其他函数**: sqrt, abs, pow, round
- **常数**: pi, e

**使用示例：**
```
sin(x) + cos(x)          # 三角函数
exp(x) + exp(-x)         # 指数函数
log(x) / log(2)          # 对数函数
sqrt(x**2 + y**2)        # 复合函数
pi * x                    # 使用常数
```

### Q11: 历史数据查询很慢

**解决方法：**
1. 缩短查询时间范围
2. 添加从站ID筛选条件
3. 定期清理旧数据
4. 考虑对数据库进行优化

### Q12: 右键菜单中颜色设置不可用

**原因：**
在多通道模式下，颜色设置会被禁用，因为每个通道使用独立的颜色。

**解决方法：**
通过"修改配置"对话框设置单个通道的颜色。

## 技术支持

### 获取帮助

如果遇到问题：

1. **查看日志**
   - 程序运行时会在控制台输出调试信息
   - 记录错误信息以便排查

2. **检查文档**
   - 阅读本文档的相关章节
   - 查看程序中的提示信息

3. **数据库问题**
   - 检查 `modbus_data.db` 文件是否存在
   - 确认文件未被其他程序占用

### 性能优化建议

1. **合理设置采集间隔**
   - 建议采集间隔 ≥ 100ms
   - 采集间隔过短可能导致性能问题

2. **合理设置存储间隔**
   - 存储间隔应 ≥ 采集间隔
   - 建议存储间隔 ≥ 5秒

3. **定期清理数据**
   - 删除不需要的历史数据
   - 保持数据库文件大小合理

4. **通道数量控制**
   - 多通道模式下建议通道数 ≤ 10
   - 过多通道可能影响性能

### 数据安全

**建议：**
1. 定期备份数据库文件
2. 删除数据前仔细确认
3. 不要手动编辑数据库文件
4. 使用程序导出功能备份数据

## 附录

### 快捷键

- **Ctrl + Enter**: 绘制曲线（函数绘制标签页）
- **F5**: 刷新查询结果（历史数据标签页）
- **Delete**: 删除选中项

### 支持的文件格式

- **数据库**: SQLite (.db)
- **导出**: CSV (.csv)

### 更新日志

**版本 1.0.0**
- 初始版本发布
- 支持函数曲线绘制
- 支持Modbus TCP/RTU连接
- 支持多通道数据采集
- 支持历史数据查询
- 支持数据导出

---

**祝您使用愉快！**

如有任何问题或建议，欢迎反馈。
